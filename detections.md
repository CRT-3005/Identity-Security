# ðŸ” Identity Attack Detection

This section demonstrates how identity-based attacks against Active Directory are detected by Splunk Enterprise using Windows Security Event Logs.  
After validating log ingestion from the Domain Controller (ADDC01) and configuring advanced audit policies, a **Kerberos password spray attack** was simulated from the Kali attacker machine using **Kerbrute**.  
Splunk was then used to identify and analyze the Kerberos authentication events generated by this activity.

---

## **Objective**
To simulate and detect a Kerberos-based identity attackâ€”specifically, a **Kerberos AS-REQ (TGT request)** triggered by an invalid password attemptâ€”using **Kerbrute** from the attacker machine (192.168.10.250).  
This demonstrates how identity-centric authentication activity appears in Splunk and how analysts can detect credential-guessing attempts.

---

## **Attack Execution (Kali Linux)**

A single-user password spray was conducted using `kerbrute` with a small user list and controlled delay to avoid account lockouts.

```bash
echo "JNeutron" > /tmp/users.txt

kerbrute passwordspray \
  --dc 192.168.10.7 \
  -d ADProject.local \
  --delay 1000 \
  --safe \
  -v \
  /tmp/users.txt Welcome123
```

<img width="773" height="323" alt="image" src="https://github.com/user-attachments/assets/9072fc05-f775-470f-924a-b6640ef1b684" />

### **Figure 1 â€“ Kerbrute Output**

The following output confirms Kerbrute successfully contacted the KDC running on the Domain Controller (192.168.10.7:88) and attempted authentication using an invalid password.

```
Using KDC(s):
  192.168.10.7:88
[!] JNeutron@ADProject.local:Welcome123 - Invalid password
Done! Tested 1 logins (0 successes)
```

---

## **Detection in Splunk**

To ensure full visibility even when EventCode extraction varies, a regex-assisted SPL query was used to extract Kerberos Account Logon events directly from the raw Security XML logs.  
This method is reliable even when Windows fields are inconsistently normalized.

### **Splunk Search (regex-assisted)**

```spl
index=identity host=ADDC01 source="WinEventLog:Security" earliest=-10m
| rex field=_raw "<EventID>(?<EventID>\d+)</EventID>"
| rex field=_raw "(?i)<Data Name=\"TargetUser(?:Name|Name)\">(?<TargetUserName>[^<]+)"
| rex field=_raw "(?i)<Data Name=\"IpAddress\">(?<IpAddress>[^<]*)"
| where _indextime>=relative_time(now(), "-5m")
| search EventID=4768 OR EventID=4771
| table _time _indextime EventID TargetUserName IpAddress host
| sort -_indextime
```

<img width="1882" height="795" alt="KerberosSplunkLogs" src="https://github.com/user-attachments/assets/a8066f04-97cf-41a3-b736-f79cce8a4b0d" />

### **Figure 2 â€“ Splunk Kerberos Detection**

Splunk successfully identified **EventID 4768**, showing that the Domain Controller processed the Kerberos TGT request made during the attack.

Key fields observed:

- **EventID:** 4768  
- **TargetUserName:** JNeutron  
- **IpAddress:** 192.168.10.250 (Kali attacker)  
- **host:** ADDC01 (Domain Controller)

This confirms that the identity-based attack triggered Kerberos authentication log activity on the DC and was successfully ingested and analyzed in Splunk.

---

## **Audit Policy Configuration (Domain Controller)**

To ensure Kerberos-related identity logs were fully captured, the following advanced audit subcategories were enabled:

```powershell
auditpol /set /subcategory:"Kerberos Authentication Service" /success:enable /failure:enable
auditpol /set /subcategory:"Kerberos Service Ticket Operations" /success:enable /failure:enable
auditpol /set /subcategory:"Credential Validation" /success:enable /failure:enable
```

Additional configuration included:

- **Audit: Force audit policy subcategory settingsâ€¦** â†’ Enabled  
- Confirming user JNeutron requires Kerberos pre-authentication  
- Restarting the Splunk Universal Forwarder  
- Applying domain policies using `gpupdate /force`

---

## **MITRE ATT&CK Mapping**

| Technique ID | Name | Description |
|--------------|------|-------------|
| **T1110.003** | Password Spraying | Testing one password across multiple accounts to avoid lockout. |
| **T1558** | Steal or Forge Kerberos Tickets | Interaction with the KDC during Kerberos authentication attempts. |
| **TA0006** | Credential Access | Core tactical goalâ€”obtain or guess valid credentials. |

---

## **Summary**

This test demonstrates full end-to-end detection of a Kerberos-based identity attack:

1. **Kerbrute** performs a password spray against `JNeutron`  
2. **Domain Controller (ADDC01)** logs Kerberos authentication activity (EventID 4768)  
3. **Splunk** ingests and parses the Security log  
4. **Analyst** identifies suspicious Kerberos authentication behavior  

This completes the identity threat simulation and validates Splunkâ€™s capability to detect authentication anomalies within a Windows Active Directory environment.
